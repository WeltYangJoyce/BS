project/
â”‚
â”œâ”€â”€ backend/
â”‚   â”‚
â”‚   â”œâ”€â”€ app.py                     # Flask å…¥å£ï¼ˆâœ… å®Œæˆï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ database.py                # DB / Session / UPLOAD_DIRï¼ˆâœ… å®Œæˆï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ models.py                  # User / Image/Tag æ¨¡å‹ï¼ˆâœ… å®Œæˆï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ requirements.txt           # åç«¯ä¾èµ–ï¼ˆâœ… å®Œæˆï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ uploads/                   # å›¾ç‰‡æ–‡ä»¶æ ¹ç›®å½•ï¼ˆâœ… ä½¿ç”¨ä¸­ï¼‰
â”‚   â”‚   â”œâ”€â”€ original/              # åŸå›¾å­˜æ”¾ç›®å½•ï¼ˆâœ…ï¼‰
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ thumbs/                # ç¼©ç•¥å›¾ç›®å½•ï¼ˆâ­ Phase 5ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ user_routes.py         # æ³¨å†Œ / ç™»å½•ï¼ˆâœ… å®Œæˆï¼‰
â”‚   â”‚   |
|   |   â”œâ”€â”€ tag_routes.py          
â”‚   â”‚   â””â”€â”€ image_routes.py        # å›¾ç‰‡ä¸Šä¼  / åˆ—è¡¨ / åˆ é™¤ï¼ˆğŸ”„ é—­ç¯ä¸­ï¼‰
â”‚   
â”‚
â”œâ”€â”€ frontend/
â”‚   â”‚
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ api.js
|   |   |   â”œâ”€â”€ tag.js
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.js            # login / registerï¼ˆâœ…ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ image.js           # fetchImages / uploadImageï¼ˆğŸ”„ï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”‚   â”œâ”€â”€ Home.jsx
|   |   |   â”œâ”€â”€ Upload.jsx
|   |   |   â”œâ”€â”€ UserCenter.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Login.jsx          # ç™»å½•é¡µï¼ˆâœ…ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ Register.jsx       # æ³¨å†Œé¡µï¼ˆâœ…ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ Gallery.jsx        # å›¾ç‰‡å±•ç¤ºé¡µï¼ˆğŸ”„ï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ components/
|   |   |   â”œâ”€â”€BackToHomeButton.jsx
|   |   |   â”œâ”€â”€GalleryGrid.jsx
|   |   |   â”œâ”€â”€ImageCard.jsx
|   |   |   â”œâ”€â”€MyImageCard.jsx
|   |   |   â”œâ”€â”€UploadPanel.jsx
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚
â”‚   â”‚   |
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚   
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ App.jsx                # è·¯ç”±å…¥å£ï¼ˆâœ…ï¼‰
â”‚   â”‚   â”œâ”€â”€ main.jsx               # React å¯åŠ¨ï¼ˆâœ…ï¼‰
â”‚   â”‚   â””â”€â”€ index.css
â”‚   â”‚
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ .env                           # ç¯å¢ƒå˜é‡ï¼ˆâ­ Phase 3ï¼‰
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md

# backend/routes/image_routes.py
# backend/routes/image_routes.py
from flask import Blueprint, request
from sqlalchemy.orm import Session
from werkzeug.utils import secure_filename
from sqlalchemy import desc
from sqlalchemy.exc import IntegrityError
import os

from flask_jwt_extended import (
    jwt_required,
    get_jwt_identity,
    verify_jwt_in_request
)

from PIL import Image as PILImage
import exifread

from database import SessionLocal, UPLOAD_DIR
from models import Image, ImageLike, Tag
from sqlalchemy import func, desc



image_bp = Blueprint("image", __name__, url_prefix="/api")

ALLOWED_EXTENSIONS = {"png", "jpg", "jpeg", "gif"}

ORIGINAL_DIR = "original"
THUMB_DIR = "thumbs"

# =============================
# å·¥å…·å‡½æ•°
# =============================
def allowed_file(filename: str) -> bool:
    return "." in filename and filename.rsplit(".", 1)[1].lower() in ALLOWED_EXTENSIONS


def extract_exif_time(filepath: str) -> str | None:
    try:
        with open(filepath, "rb") as f:
            tags = exifread.process_file(f, details=False)
        if "EXIF DateTimeOriginal" in tags:
            return str(tags["EXIF DateTimeOriginal"])
    except Exception as e:
        print("EXIF parse failed:", e)

    return None


# =============================
# POST /api/images  ä¸Šä¼ å›¾ç‰‡
# =============================
@image_bp.route("/images", methods=["POST"])
@jwt_required()
def upload_image():
    db: Session = SessionLocal()
    user_id = int(get_jwt_identity())

    if "file" not in request.files:
        return {"error": "No file provided"}, 400

    file = request.files["file"]

    if file.filename == "":
        return {"error": "Empty filename"}, 400

    if not allowed_file(file.filename):
        return {"error": "File type not allowed"}, 400

    filename = secure_filename(file.filename)

    # ä¿å­˜åŸå›¾
    original_path = os.path.join(UPLOAD_DIR, ORIGINAL_DIR, filename)
    os.makedirs(os.path.dirname(original_path), exist_ok=True)
    file.save(original_path)

    pil_img = PILImage.open(original_path)
    width, height = pil_img.size

    # Phase 2ï¼šç¼©ç•¥å›¾æš‚ç”¨åŸå›¾
    thumb_path = os.path.join(UPLOAD_DIR, THUMB_DIR, filename)
    os.makedirs(os.path.dirname(thumb_path), exist_ok=True)
    pil_img.copy().save(thumb_path)

    exif_time = extract_exif_time(original_path)

    image = Image(
        user_id=user_id,
        filename=f"{ORIGINAL_DIR}/{filename}",
        thumbnail_filename=f"{THUMB_DIR}/{filename}",
        resolution_width=width,
        resolution_height=height,
        exif_time=exif_time,
    )

    db.add(image)
    db.commit()
    db.refresh(image)

    return {
        "id": image.id,
        "url": f"/uploads/{image.filename}",
        "thumbnail_url": f"/uploads/{image.thumbnail_filename}",
    }


# =============================
# GET /api/images  å›¾ç‰‡åˆ—è¡¨ï¼ˆæ”¯æŒæ’åºï¼‰
# =============================
@image_bp.route("/images", methods=["GET"])
def list_images():
    db: Session = SessionLocal()

    # å¯é€‰ç™»å½•
    user_id = None
    try:
        verify_jwt_in_request(optional=True)
        identity = get_jwt_identity()
        if identity:
            user_id = int(identity)
    except:
        pass

    sort = request.args.get("sort", "time")
    tag_name = request.args.get("tag")  # â­ æ–°å¢

    query = db.query(Image)

    # ğŸ”– Tag è¿‡æ»¤
    if tag_name:
        query = query.join(Image.tags).filter(Tag.name == tag_name)

    images = query.all()

    # ğŸ”¥ Python å±‚æ’åºï¼ˆä¸ä½ ç°åœ¨ä¸€è‡´ï¼‰
    if sort == "hot":
        images.sort(
            key=lambda img: (img.likes or 0) + (img.views or 0),
            reverse=True
        )
    else:
        images.sort(
            key=lambda img: img.upload_time,
            reverse=True
        )

    liked_image_ids = set()
    if user_id:
        liked_image_ids = {
            il.image_id
            for il in db.query(ImageLike)
            .filter(ImageLike.user_id == user_id)
            .all()
        }

    return {
        "images": [
            {
                "id": img.id,
                "url": f"/uploads/{img.filename}",
                "thumbnail_url": f"/uploads/{img.thumbnail_filename}",
                "likes": img.likes,
                "views": img.views,
                "liked": img.id in liked_image_ids,
                "tags": [t.name for t in img.tags],  # â­ è¿”å› tags
                "upload_time": img.upload_time.isoformat(),
            }
            for img in images
        ]
    }


# =============================
# DELETE /api/images/<id>
# =============================
@image_bp.route("/images/<int:image_id>", methods=["DELETE"])
@jwt_required()
def delete_image(image_id: int):
    db: Session = SessionLocal()
    user_id = int(get_jwt_identity())

    image = db.query(Image).filter(Image.id == image_id).first()
    if not image:
        return {"error": "Image not found"}, 404

    if image.user_id != user_id:
        return {"error": "Forbidden"}, 403

    for path in [image.filename, image.thumbnail_filename]:
        full_path = os.path.join(UPLOAD_DIR, path)
        if os.path.exists(full_path):
            os.remove(full_path)

    db.delete(image)
    db.commit()

    return {"message": "Image deleted"}


# =============================
# POST /api/images/<id>/view
# =============================
@image_bp.route("/images/<int:image_id>/view", methods=["POST"])
def view_image(image_id: int):
    db: Session = SessionLocal()

    image = db.query(Image).filter(Image.id == image_id).first()
    if not image:
        return {"error": "Image not found"}, 404

    image.views += 1
    db.commit()

    return {"views": image.views}


# =============================
# POST /api/images/<id>/like
# =============================
@image_bp.route("/images/<int:image_id>/like", methods=["POST"])
@jwt_required()
def toggle_like(image_id: int):
    db: Session = SessionLocal()
    user_id = int(get_jwt_identity())

    image = db.query(Image).filter(Image.id == image_id).first()
    if not image:
        return {"error": "Image not found"}, 404

    like = (
        db.query(ImageLike)
        .filter(
            ImageLike.user_id == user_id,
            ImageLike.image_id == image_id
        )
        .first()
    )

    if like:
        db.delete(like)
        image.likes = max(image.likes - 1, 0)
        db.commit()
        return {"liked": False, "likes": image.likes}

    new_like = ImageLike(user_id=user_id, image_id=image_id)
    db.add(new_like)
    image.likes += 1
    db.commit()

    return {"liked": True, "likes": image.likes}


# =============================
# GET /api/images/mine
# =============================
@image_bp.route("/images/mine", methods=["GET"])
@jwt_required()
def list_my_images():
    db: Session = SessionLocal()
    user_id = int(get_jwt_identity())

    images = (
        db.query(Image)
        .filter(Image.user_id == user_id)
        .order_by(Image.upload_time.desc())
        .all()
    )

    result = []
    for img in images:
        result.append({
            "id": img.id,
            "url": f"/uploads/{img.filename}",
            "thumbnail_url": f"/uploads/{img.thumbnail_filename}",
            "width": img.resolution_width,
            "height": img.resolution_height,
            "likes": img.likes,
            "views": img.views,
            "upload_time": img.upload_time.isoformat(),
        })

    return {"images": result}
#backend/routes/tag_routes.py
from flask import Blueprint
from database import SessionLocal
from models import Tag

tag_bp = Blueprint("tag", __name__, url_prefix="/api")

@tag_bp.route("/tags", methods=["GET"])
def list_tags():
    db = SessionLocal()
    tags = db.query(Tag).order_by(Tag.name.asc()).all()

    return {
        "tags": [
            {"id": t.id, "name": t.name}
            for t in tags
        ]
    }
#backend/routes/user_routes.py
from flask import Blueprint, request, jsonify
from werkzeug.security import generate_password_hash, check_password_hash
from sqlalchemy.orm import Session
from flask_jwt_extended import create_access_token

from database import SessionLocal
from models import User

user_bp = Blueprint("user", __name__)


@user_bp.route("/register", methods=["POST"])
def register():
    data = request.get_json()
    if not data:
        return {"error": "Invalid JSON"}, 400

    username = data.get("username")
    email = data.get("email")
    password = data.get("password")

    if not username or not email or not password:
        return {"error": "Missing fields"}, 400

    db: Session = SessionLocal()

    if db.query(User).filter(User.username == username).first():
        return {"error": "Username already exists"}, 400

    if db.query(User).filter(User.email == email).first():
        return {"error": "Email already exists"}, 400

    new_user = User(
        username=username,
        email=email,
        password_hash=generate_password_hash(password)
    )

    db.add(new_user)
    db.commit()
    db.refresh(new_user)

    return {
        "message": "User registered",
        "user": {
            "id": new_user.id,
            "username": new_user.username,
            "email": new_user.email
        }
    }, 201


@user_bp.route("/login", methods=["POST"])
def login():
    data = request.get_json()
    if not data:
        return {"error": "Invalid JSON"}, 400

    username = data.get("username")
    password = data.get("password")

    if not username or not password:
        return {"error": "Missing fields"}, 400

    db: Session = SessionLocal()
    user = db.query(User).filter(User.username == username).first()

    if not user or not check_password_hash(user.password_hash, password):
        return {"error": "Invalid username or password"}, 401

    # ğŸ”‘ æ ¸å¿ƒï¼šç”Ÿæˆ JWT
    access_token = create_access_token(identity=str(user.id))

    return jsonify({
        "access_token": access_token,
        "user": {
            "id": user.id,
            "username": user.username,
            "email": user.email
        }
    }), 200
#backend/app.py
# backend/app.py
from flask import Flask, send_from_directory
from flask_cors import CORS
from flask_jwt_extended import JWTManager

from database import init_db, UPLOAD_DIR
from routes.user_routes import user_bp
from routes.image_routes import image_bp
from routes.tag_routes import tag_bp

# =============================
# åˆ›å»º Flask App
# =============================

app = Flask(__name__)

# =============================
# åŸºç¡€é…ç½®
# =============================

app.config["SECRET_KEY"] = "dev-secret-key"  # Phase 3 å¯æ¢ä¸ºç¯å¢ƒå˜é‡
app.config["JWT_SECRET_KEY"] = "jwt-secret-key"
app.config["JWT_ACCESS_TOKEN_EXPIRES"] = False  # Phase 2 ä¸è®¾ç½®è¿‡æœŸï¼Œåé¢å†åŠ 

# =============================
# æ‰©å±•åˆå§‹åŒ–
# =============================

CORS(app)
jwt = JWTManager(app)

# =============================
# æ•°æ®åº“åˆå§‹åŒ–
# =============================

init_db()

# =============================
# æ³¨å†Œ Blueprint
# =============================

app.register_blueprint(user_bp, url_prefix="/api")
app.register_blueprint(image_bp, url_prefix="/api")
app.register_blueprint(tag_bp,url_prefix="/api")

# =============================
# é™æ€æ–‡ä»¶è®¿é—®ï¼ˆå›¾ç‰‡ï¼‰
# =============================

@app.route("/uploads/<path:filename>")
def uploaded_file(filename):
    """
    è®¿é—®è·¯å¾„ç¤ºä¾‹ï¼š
    http://localhost:5000/uploads/original/xxx.jpg
    http://localhost:5000/uploads/thumbs/xxx.jpg
    """
    return send_from_directory(UPLOAD_DIR, filename)

from flask_jwt_extended import JWTManager
from flask import jsonify

@jwt.invalid_token_loader
def invalid_token_callback(reason):
    return jsonify({"error": "invalid_token", "reason": reason}), 422

@jwt.unauthorized_loader
def missing_token_callback(reason):
    return jsonify({"error": "missing_token", "reason": reason}), 401


# =============================
# å¯åŠ¨å…¥å£
# =============================

if __name__ == "__main__":
    app.run(debug=True)
#backend/database.py
# backend/database.py
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, declarative_base

# =============================
# åŸºç¡€è·¯å¾„
# =============================

BASE_DIR = os.path.dirname(os.path.abspath(__file__))

DATA_DIR = os.path.join(BASE_DIR, "data")
UPLOAD_DIR = os.path.join(DATA_DIR, "uploads")

ORIGINAL_DIR = os.path.join(UPLOAD_DIR, "original")
THUMB_DIR = os.path.join(UPLOAD_DIR, "thumbs")

# =============================
# ç¡®ä¿ç›®å½•å­˜åœ¨
# =============================

os.makedirs(DATA_DIR, exist_ok=True)
os.makedirs(ORIGINAL_DIR, exist_ok=True)
os.makedirs(THUMB_DIR, exist_ok=True)

# =============================
# æ•°æ®åº“é…ç½®
# =============================

DATABASE_PATH = os.path.join(DATA_DIR, "user.db")
DATABASE_URL = f"sqlite:///{DATABASE_PATH}"

engine = create_engine(
    DATABASE_URL,
    connect_args={"check_same_thread": False}
)

SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine
)

Base = declarative_base()

# =============================
# åˆå§‹åŒ–æ•°æ®åº“ï¼ˆç”± app.py è°ƒç”¨ï¼‰
# =============================

def init_db():
    import models  # ç¡®ä¿ models è¢«åŠ è½½
    Base.metadata.create_all(bind=engine)
#backend/models.py
# backend/models.py
from sqlalchemy import (
    Column,
    Integer,
    String,
    DateTime,
    ForeignKey
)
from sqlalchemy.orm import relationship
from datetime import datetime

from database import Base

from sqlalchemy import Column, Integer, String, ForeignKey, Table
from sqlalchemy.orm import relationship
from database import Base

# =============================
# Image-Tags è¡¨
# =============================
image_tags = Table(
    "image_tags",
    Base.metadata,
    Column("image_id", Integer, ForeignKey("images.id")),
    Column("tag_id", Integer, ForeignKey("tags.id")),
)

class Tag(Base):
    __tablename__ = "tags"

    id = Column(Integer, primary_key=True)
    name = Column(String(50), unique=True, nullable=False)
# =============================
# User è¡¨
# =============================

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, autoincrement=True)

    username = Column(String(50), unique=True, nullable=False)
    email = Column(String(120), unique=True, nullable=False)
    password_hash = Column(String(255), nullable=False)

    # åå‘å…³ç³»
    images = relationship(
        "Image",
        back_populates="user",
        cascade="all, delete-orphan"
    )


# =============================
# Image è¡¨
# =============================

class Image(Base):
    __tablename__ = "images"

    id = Column(Integer, primary_key=True, autoincrement=True)

    # å¤–é”®
    user_id = Column(
        Integer,
        ForeignKey("users.id", ondelete="CASCADE"),
        nullable=False
    )

    # æ–‡ä»¶ä¿¡æ¯
    filename = Column(String(255), nullable=False)
    thumbnail_filename = Column(String(255), nullable=False)

    # ä¸Šä¼ æ—¶é—´
    upload_time = Column(DateTime, default=datetime.utcnow)

    # EXIF ä¿¡æ¯ï¼ˆPhase 2 åŸºç¡€ï¼‰
    exif_time = Column(String(50), nullable=True)
    exif_location = Column(String(255), nullable=True)

    # åˆ†è¾¨ç‡
    resolution_width = Column(Integer, nullable=True)
    resolution_height = Column(Integer, nullable=True)

    # çƒ­åº¦
    views = Column(Integer, default=0)
    likes = Column(Integer, default=0)

    # å…³ç³»
    user = relationship("User", back_populates="images")

    tags =relationship(
        "Tag",
        secondary=image_tags,
        backref= "images"
    )

# =============================
# Image-likes è¡¨
# =============================

from sqlalchemy import UniqueConstraint

class ImageLike(Base):
    __tablename__ = "image_likes"

    id = Column(Integer, primary_key=True, autoincrement=True)

    user_id = Column(
        Integer,
        ForeignKey("users.id", ondelete="CASCADE"),
        nullable=False
    )

    image_id = Column(
        Integer,
        ForeignKey("images.id", ondelete="CASCADE"),
        nullable=False
    )

    __table_args__ = (
        UniqueConstraint("user_id", "image_id", name="uix_user_image_like"),
    )


#frontend/src/api/api.js
import axios from 'axios'

const api = axios.create({
  baseURL: 'http://localhost:5000/api',
})

// æ¯ä¸ªè¯·æ±‚è‡ªåŠ¨å¸¦ JWT
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => Promise.reject(error)
)

export default api
#frontend/src/api/auth.js
import api from './api'

export const login = async (payload) => {
  const res = await api.post('/login', payload)
  return res.data
}

export const register = async (payload) => {
  const res = await api.post('/register', payload)
  return res.data
}
#frontend/src/api/image.js
import api from './api'

// è·å–å›¾ç‰‡åˆ—è¡¨ï¼ˆæ”¯æŒæ’åºï¼‰
export const fetchImages = ({ sort = 'time', tag = null }) => {
  return api.get('/images', {
    params: {
      sort,
      tag,
    },
  })
}


// ä¸Šä¼ å›¾ç‰‡
export const uploadImage = (file) => {
  const formData = new FormData()
  formData.append('file', file)
  return api.post('/images', formData)
}

// åˆ é™¤å›¾ç‰‡
export const deleteImage = (id) => {
  return api.delete(`/images/${id}`)
}

// è®°å½•æµè§ˆé‡
export const viewImage = (id) => {
  return api.post(`/images/${id}/view`)
}

// ç‚¹èµ / å–æ¶ˆç‚¹èµ
export const toggleLike = (id) => {
  return api.post(`/images/${id}/like`)
}

// å½“å‰ç”¨æˆ·å›¾ç‰‡
export const fetchMyImages = () => {
  return api.get('/images/mine')
}

export const fetchTags = () => {
  return api.get('/tags')
}
#frontend/src/api/tag.js
import api from "./api";

// è·å–æ‰€æœ‰ tags
export const fetchTags = () => {
  return api.get("/tags");
};
#frontend/src/components/BackToHomeButton.jsx
import { useNavigate } from 'react-router-dom'

export default function BackToHomeButton() {
  const navigate = useNavigate()

  return (
    <button
      onClick={() => navigate('/home')}
      style={{
        marginBottom: 20,
        padding: '6px 12px',
        cursor: 'pointer',
      }}
    >
      â† Back to Home
    </button>
  )
}
#frontend/src/components/GalleryGrid.jsx
import ImageCard from './ImageCard'

export default function GalleryGrid({ images, onChange }) {
  return (
    <div
      style={{
        display: 'grid',
        gridTemplateColumns: 'repeat(auto-fill, 200px)',
        gap: 16,
      }}
    >
      {images.map(img => (
        <ImageCard
          key={img.id}
          image={img}
          onChange={onChange}
        />
      ))}
    </div>
  )
}
#frontend/src/components/ImageCard.jsx
import { useState } from 'react'
import { toggleLike, viewImage } from '../api/image'

export default function ImageCard({ image, onChange }) {
  const [liked, setLiked] = useState(image.liked)
  const [likes, setLikes] = useState(image.likes)
  const [views, setViews] = useState(image.views)

  const handleView = async () => {
    const res = await viewImage(image.id)
    setViews(res.data.views)
    onChange?.()
  }

  const handleLike = async (e) => {
    e.stopPropagation()
    const res = await toggleLike(image.id)
    setLiked(res.data.liked)
    setLikes(res.data.likes)
    onChange?.()
  }

  return (
    <div style={{ position: 'relative' }}>
      <img
        src={`http://localhost:5000${image.thumbnail_url}`}
        alt=""
        style={{ width: 200, height: 200, objectFit: 'cover' }}
        onClick={() => {
          handleView()
          window.open(
            `http://localhost:5000${image.url}`,
            '_blank'
          )
        }}
      />

      <div style={{ position: 'absolute', bottom: 8, left: 8 }}>
        ğŸ‘€ {views}
      </div>

      <div
        onClick={handleLike}
        style={{
          position: 'absolute',
          bottom: 8,
          right: 8,
          cursor: 'pointer',
          color: liked ? 'red' : '#fff',
        }}
      >
        â¤ï¸ {likes}
      </div>
    </div>
  )
}
#frontend/src/components/MyImageCard.jsx
import { deleteImage } from '../api/image'

export default function MyImageCard({ image, onDeleted }) {
  const handleDelete = async (e) => {
    e.stopPropagation()

    if (!window.confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return

    try {
      await deleteImage(image.id)
      onDeleted(image.id) // âœ… é€šçŸ¥çˆ¶ç»„ä»¶åŒæ­¥ state
    } catch (err) {
      alert('Delete failed')
    }
  }

  return (
    <div
      style={{
        position: 'relative',
        width: 200,
        height: 200,
        borderRadius: 6,
        overflow: 'hidden',
      }}
    >
      <img
        src={`http://localhost:5000${image.thumbnail_url}`}
        alt=""
        style={{
          width: '100%',
          height: '100%',
          objectFit: 'cover',
          cursor: 'pointer',
        }}
        onClick={() =>
          window.open(
            `http://localhost:5000${image.url}`,
            '_blank'
          )
        }
      />

      {/* ğŸ—‘ åˆ é™¤æŒ‰é’® */}
      <button
        onClick={handleDelete}
        style={{
          position: 'absolute',
          top: 6,
          right: 6,
          background: 'rgba(0,0,0,0.7)',
          color: '#fff',
          border: 'none',
          borderRadius: 4,
          fontSize: 12,
          padding: '4px 6px',
          cursor: 'pointer',
        }}
      >
        åˆ é™¤
      </button>

      {/* ğŸ”§ æœªæ¥æ‰©å±•ä½ï¼ˆç°åœ¨ä¸å¯ç”¨ï¼‰ */}
      {/*
      <div style={{
        position: 'absolute',
        bottom: 6,
        left: 6,
        display: 'flex',
        gap: 6
      }}>
        <button>ç¼–è¾‘</button>
        <button>Tag</button>
      </div>
      */}
    </div>
  )
}
#frontend/src/components/UploadPanel.jsx
export default function UploadPanel({ onUpload, uploading }) {
  return (
    <div style={{ marginBottom: 20 }}>
      <input
        type="file"
        accept="image/*"
        onChange={e => {
          const file = e.target.files[0]
          if (file) onUpload(file)
          e.target.value = ''
        }}
        disabled={uploading}
      />
      {uploading && <p>Uploading...</p>}
    </div>
  )
}
#frontend/src/pages/Gallery.jsx
import { useEffect, useState, useCallback } from 'react'
import { fetchImages } from '../api/image'
import { fetchTags } from '../api/tag'
import GalleryGrid from '../components/GalleryGrid'
import BackToHomeButton from '../components/BackToHomeButton'
export default function Gallery() {
  const [images, setImages] = useState([])
  const [tags, setTags] = useState([])

  const [sort, setSort] = useState('time')
  const [activeTag, setActiveTag] = useState(null)

  const loadImages = useCallback(() => {
    fetchImages({ sort, tag: activeTag })
      .then(res => setImages(res.data.images))
  }, [sort, activeTag])

  useEffect(() => {
    fetchTags().then(res => setTags(res.data.tags))
  }, [])

  useEffect(() => {
    loadImages()
  }, [loadImages])

  return (
    <div style={{ padding: 40 }}>
       <BackToHomeButton />
      <h2>Gallery</h2>

      {/* æ’åº */}
      <div style={{ display: "flex", gap: 12, marginBottom: 20 }}>
        <button
          onClick={() => setSort("time")}
          style={{
            padding: "6px 12px",
            background: sort === "time" ? "#333" : "#eee",
            color: sort === "time" ? "#fff" : "#000",
            borderRadius: 4,
            cursor: "pointer",
          }}
        >
          ğŸ•’ Time
        </button>

        <button
          onClick={() => setSort("hot")}
          style={{
            padding: "6px 12px",
            background: sort === "hot" ? "#ff6b00" : "#eee",
            color: sort === "hot" ? "#fff" : "#000",
            borderRadius: 4,
            cursor: "pointer",
          }}
        >
          ğŸ”¥ Hot
        </button>
      </div>


      {/* Tag ç­›é€‰ */}
      <div style={{ margin: '16px 0' }}>
        <button
          onClick={() => setActiveTag(null)}
          style={{ fontWeight: !activeTag ? 'bold' : 'normal' }}
        >
          All
        </button>

        {tags.map(tag => (
          <button
            key={tag.id}
            onClick={() => setActiveTag(tag.name)}
            style={{
              marginLeft: 8,
              fontWeight: activeTag === tag.name ? 'bold' : 'normal'
            }}
          >
            #{tag.name}
          </button>
        ))}
      </div>

      <GalleryGrid images={images} onChange={loadImages} />
    </div>
  )
}
#frontend/src/pages/Home.jsx
import { useNavigate } from 'react-router-dom'

export default function Home({ setToken }) {
  console.log('âš ï¸ Home rendered')
  const navigate = useNavigate()
  const username = localStorage.getItem('username')
  const handleLogout = () => {
    localStorage.removeItem('token')
    localStorage.removeItem('username')
    setToken(null)
    navigate('/login')
  }

  return (
    <div style={{ padding: 40 }}>
      <h2>Home</h2>
      <div style={{ marginBottom: 20 }}>
        Welcome, <strong>{username}</strong>
      </div>
      <button onClick={() => navigate('/gallery')}>
        Go to Gallery
      </button>

      <br /><br />
      <button onClick={() => navigate('/user')}>
        My Images
      </button>
      <br/><br/>
      <button onClick={handleLogout}>
        Logout
      </button>
    </div>
  )
}
#frontend/src/pages/Login.jsx
import { useState } from 'react'
import { useNavigate, Link } from 'react-router-dom'
import { login } from '../api/auth'

export default function Login({setToken}) {
  const [username, setUsername] = useState('')
  const [password, setPassword] = useState('')
  const navigate = useNavigate()

  const handleLogin = async () => {
    try {
      const data = await login({ username, password })
      console.log('LOGIN RESPONSE:', data)
      console.log(data.access_token)
      localStorage.setItem('token', data.access_token)
      console.log("set localStorage=",data.access_token)
      localStorage.setItem('username', data.user.username)
      setToken(data.access_token)
      console.log("set Token = ",data.access_token)
      navigate('/home')
      console.log("to home")
    } catch {
      alert('Login failed')
    }
  }

  return (
    <div style={{ padding: 40 }}>
      <h2>Login</h2>
      <input
        placeholder="Username"
        value={username}
        onChange={e => setUsername(e.target.value)}
      />
      <br />
      <input
        type="password"
        placeholder="Password"
        value={password}
        onChange={e => setPassword(e.target.value)}
      />
      <br />
      <button onClick={handleLogin}>Login</button>
      <p>
        No account? <Link to="/register">Register</Link>
      </p>
    </div>
  )
}
#frontend/src/pages/Register.jsx
import { useState } from 'react'
import { useNavigate, Link } from 'react-router-dom'
import { register } from '../api/auth'

export default function Register() {
  const [username, setUsername] = useState('')
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const navigate = useNavigate()

  const handleRegister = async () => {
    try {
      await register({ username, email, password })
      alert('Register success')
      navigate('/login')
    } catch {
      alert('Register failed')
    }
  }

  return (
    <div style={{ padding: 40 }}>
      <h2>Register</h2>
      <input
        placeholder="Username"
        value={username}
        onChange={e => setUsername(e.target.value)}
      />
      <br />
      <input
        placeholder="Email"
        value={email}
        onChange={e => setEmail(e.target.value)}
      />
      <br />
      <input
        type="password"
        placeholder="Password"
        value={password}
        onChange={e => setPassword(e.target.value)}
      />
      <br />
      <button onClick={handleRegister}>Register</button>
      <p>
        Already have an account? <Link to="/login">Login</Link>
      </p>
    </div>
  )
}
#frontend/src/pages/Upload.jsx
import { useState } from 'react'
import UploadPanel from '../components/UploadPanel'
import { uploadImage } from '../api/image'
import { useNavigate } from 'react-router-dom'

export default function Upload() {
  const [uploading, setUploading] = useState(false)
  const navigate = useNavigate()

  const handleUpload = async (file) => {
    try {
      setUploading(true)
      await uploadImage(file)
      alert('Upload success')
      console.log('ğŸ‘‰ upload success, navigating to /user')
      navigate('/user',{replace : true}) // ä¸Šä¼ å®Œæˆåå›åˆ°ç”¨æˆ·ä¸­å¿ƒ
    } catch (err) {
      alert('Upload failed')
    } finally {
      setUploading(false)
    }
  }

  return (
    <div style={{ padding: 40 }}>
      <h2>Upload Image</h2>

      <UploadPanel
        onUpload={handleUpload}
        uploading={uploading}
      />
    </div>
  )
}
#frontend/src/pages/UserCenter.jsx
import { useEffect, useState } from 'react'
import { fetchMyImages } from '../api/image'
import MyImageCard from '../components/MyImageCard'
import { useNavigate } from 'react-router-dom'
import BackToHomeButton from '../components/BackToHomeButton'
export default function UserCenter() {
  const [images, setImages] = useState([])
  const [loading, setLoading] = useState(true)
  const navigate = useNavigate()

  useEffect(() => {
    loadMyImages()
  }, [])

  const loadMyImages = async () => {
    setLoading(true)
    try {
      const res = await fetchMyImages()
      setImages(res.data.images)
    } catch (err) {
      alert('Failed to load images')
    } finally {
      setLoading(false)
    }
  }

  const handleDeleted = (id) => {
    // âœ… æœ¬åœ°åŒæ­¥åˆ é™¤ï¼Œä¸ reload
    setImages(prev => prev.filter(img => img.id !== id))
  }

  return (
    <div style={{ padding: 40 }}>
      <h2>æˆ‘çš„å›¾ç‰‡</h2>

      {/* âœ… ä¸Šä¼ å…¥å£ï¼ˆæ–°å¢ï¼‰ */}
      <div style={{ marginBottom: 20 }}>
         <BackToHomeButton />
        <button onClick={() => navigate('/user/upload')}>
          ä¸Šä¼ æ–°å›¾ç‰‡
        </button>
      </div>

      {loading ? (
        <p>Loading...</p>
      ) : images.length === 0 ? (
        <p>ä½ è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•å›¾ç‰‡</p>
      ) : (
        <div
          style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fill, 200px)',
            gap: 20,
          }}
        >
          {images.map(img => (
            <MyImageCard
              key={img.id}
              image={img}
              onDeleted={handleDeleted}
            />
          ))}
        </div>
      )}
    </div>
  )
}
#frontend/src/App.jsx
import { Routes, Route, Navigate } from 'react-router-dom'
import { useState } from 'react'

import Login from './pages/Login'
import Register from './pages/Register'
import Home from './pages/Home'
import Gallery from './pages/Gallery'
import UserCenter from './pages/UserCenter'
import Upload from './pages/Upload'



export default function App() {
  const [token, setToken] = useState(
    localStorage.getItem('token')
  )

  return (
    <Routes>
      <Route
        path="/login"
        element={
          token
            ? <Navigate to="/home" />
            : <Login setToken={setToken} />
        }
      />

      <Route
        path="/register"
        element={
          token
            ? <Navigate to="/home" />
            : <Register />
        }
      />

      <Route
        path="/user/upload"
        element={
          token ? <Upload /> : <Navigate to="/login" />
        }
      />


      <Route
        path="/home"
        element={
          token
            ? <Home setToken={setToken} />
            : <Navigate to="/login" />
        }
      />

      <Route
        path="/gallery"
        element={
          token
            ? <Gallery />
            : <Navigate to="/login" />
        }
      />

      <Route
        path="/user"
        element={
          token
            ? <UserCenter />
            : <Navigate to="/login" />
        }
      />

      <Route path="*" element={<Navigate to="/login" />} />
    </Routes>
  )
}
#frontend/src/main.jsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import App from './App'

ReactDOM.createRoot(document.getElementById('root')).render(
  <BrowserRouter>
    <App />
  </BrowserRouter>
)
